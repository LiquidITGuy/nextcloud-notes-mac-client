"use strict";const i18n=require("./i18n.min"),{ipcRenderer:ipcRenderer,shell:shell,remote:remote}=require("electron"),Store=require("electron-store"),store=new Store,dialog=remote.dialog,dateFormat=require("dateformat"),$=require("jquery"),marked=require("marked"),removeMarkdown=require("remove-markdown"),pretty=require("pretty"),fs=require("fs-extra"),server=store.get("loginCredentials.server"),username=store.get("loginCredentials.username"),password=store.get("loginCredentials.password");let modal;const EasyMDE=require("easymde");let easymdeSetup={element:$("#note")[0],autofocus:!1,forceSync:!0,status:!1,spellChecker:!0,toolbar:[{name:"Heading",action:EasyMDE.toggleHeadingSmaller,className:"fa fa-header",title:i18n.t("app:toolbar.heading","Heading")},"|",{name:"bold",action:EasyMDE.toggleBold,className:"fa fa-bold",title:i18n.t("app:toolbar.bold","Bold")},{name:"italic",action:EasyMDE.toggleItalic,className:"fa fa-italic",title:i18n.t("app:toolbar.italic","Italic")},{name:"srtikethrough",action:EasyMDE.toggleStrikethrough,className:"fa fa-strikethrough",title:i18n.t("app:toolbar.strikethrough","Strikethrough")},"|",{name:"unordered-list",action:EasyMDE.toggleUnorderedList,className:"fa fa-list-ul",title:i18n.t("app:toolbar.ul","Generic List")},{name:"ordered-list",action:EasyMDE.toggleOrderedList,className:"fa fa-list-ol",title:i18n.t("app:toolbar.ol","Numbered List")},"|",{name:"link",action:EasyMDE.drawLink,className:"fa fa-link",title:i18n.t("app:toolbar.link","Create Link")},{name:"image",action:EasyMDE.drawImage,className:"fa fa-picture-o",title:i18n.t("app:toolbar.image","Insert Image")},"|",{name:"code",action:EasyMDE.toggleCodeBlock,className:"fa fa-code",title:i18n.t("app:toolbar.code","Code")},{name:"quote",action:EasyMDE.toggleBlockquote,className:"fa fa-quote-left",title:i18n.t("app:toolbar.quote","Quote")},{name:"table",action:EasyMDE.drawTable,className:"fa fa-table",title:i18n.t("app:toolbar.table","Insert Table")},{name:"horizontal-rule",action:EasyMDE.drawHorizontalRule,className:"fa fa-minus",title:i18n.t("app:toolbar.hr","Insert Horizontal Line")}],shortcuts:{toggleStrikethrough:"Cmd-Alt-D",toggleBlockquote:"Cmd-'",drawTable:"Cmd-T",drawHorizontalRule:"Cmd--",cleanBlock:null,toggleSideBySide:null,toggleFullScreen:null,togglePreview:null}},easymde=new EasyMDE(easymdeSetup);function apiCall(e,t,a){let o;switch(e){case"new":o="post";break;case"save":case"update":o="put";break;case"delete":o="delete";break;default:o="get"}let r="/index.php/apps/notes/api/v0.2/notes",i={method:o,headers:{Authorization:"Basic "+btoa(username+":"+password),"Content-Type":"application/json"},mode:"cors",cache:"no-store"};t&&(r+=`/${t}`),a&&(i.body=JSON.stringify(a)),console.log(`URL: ${r}`),fetch(server+r,i).then(function(e){if(e.ok)return console.log("response OK"),e.text();dialog.showErrorBox(i18n.t("app:dialog.error.server.title","Server connection error"),i18n.t("app:dialog.error.server.text","there was an error connecting to")+`:\n${server}`),console.log(e.error())}).then(function(o){let r=JSON.parse(o);if("error"==r.status)dialog.showErrorBox(i18n.t("app:dialog.error.json.title","JSON parsing error"),i18n.t("app:dialog.error.json.text","An error occured parsing the notes")),console.log(r.message);else switch(e){case"new":store.set("appInterface.selected",r.id),$("#sidebar").html(""),apiCall("all");break;case"save":$("#sidebar").html(""),apiCall("sidebar");break;case"update":$(`button[data-id="${t}"]`).removeData("favorite"),$(`button[data-id="${t}"]`).attr("data-favorite",a.favorite);break;case"delete":$("#sidebar li button.selected").attr("data-id")==t&&(resetEditor(),store.set("appInterface.selected",null),$("#note").attr("data-id",null),$("#time, #note").html("")),$("#sidebar").html(""),apiCall("all");break;case"export":exportNote(r);break;case"sidebar":listNotes(r,"sidebar");break;default:t?displayNote(r):listNotes(r)}}).catch(function(e){dialog.showErrorBox(i18n.t("app:dialog.error.server.title","Server connection error"),i18n.t("app:dialog.error.server.text","there was an error connecting to")+`:\n${server}`),console.log(e)})}function resetEditor(){easymde.codemirror.setValue(""),easymde.value(""),$(".editor-preview").html("")}function insertTextAtCursor(e){let t=easymde.codemirror.getDoc(),a=t.getCursor();t.replaceRange(e,a)}function wrapTextToSelection(e,t){let a=easymde.codemirror.getDoc(),o=a.getSelection();a.replaceSelection(e+o+t)}function listNotes(e,t){const a=(new Date).getTime()/1e3;let o=store.get("appSettings.sortby"),r=store.get("appSettings.orderby");e.length>1&&e.sort(function(e,t){var a=e[o],i=t[o];return"asc"===r?a<i?-1:a>i?1:0:a>i?-1:a<i?1:0});for(let t of e){let e=formatDate(a,new Date(t.modified).getTime()),o=removeMarkdown(t.content.replace(/(!\[.*\]\(.*\)|<[^>]*>|>|<)/g,""));o=o?o.substr(0,120).slice(t.title.length):i18n.t("app:sidebar.notext","No additional text"),$("#sidebar").append(`<li>\n\t\t\t<button data-id="${t.id}" data-title="${t.title}" data-category="${t.category}" data-favorite="${t.favorite}">\n\t\t\t\t<span class="side-title">${t.title}</span>\n\t\t\t\t<span class="side-text">${e}&nbsp;&nbsp;${o}</span>\n\t\t\t</button>\n\t\t</li>\n\t\t`)}t?getSelected("sidebar"):getSelected()}function formatDate(e,t){return dateFormat(1e3*t,e-86400<t?"H:MM":e-604800<t?"dddd":"dd/mm/yy")}function displayNote(e){let t=i18n.t("app:date.titlebar","at"),a=dateFormat(1e3*e.modified,"d mmmm, yyyy"),o=dateFormat(1e3*e.modified,"HH:MM");$(".CodeMirror-code").addClass("hide"),$("#edit").removeClass("editing"),$("#time").html(`${a} ${t} ${o}`),resetEditor(),easymde.isPreviewActive()&&easymde.togglePreview(),$("#note").attr("data-id",e.id),easymde.value(e.content),easymde.codemirror.clearHistory(),easymde.togglePreview(),applyZoom(store.get("appSettings.zoom")),$(".CodeMirror-code").removeClass("hide")}function getSelected(e){let t=store.get("appInterface.selected");t&&($(`button[data-id="${t}"]`).addClass("selected").parent().prev().children().addClass("above-selected"),e||apiCall("single",t))}function editNote(){let e=store.get("appInterface.selected");if(e)if(easymde.isPreviewActive())$("#edit").attr("title",i18n.t("app:main.button.save","Save Note")).addClass("editing"),easymde.togglePreview(),easymde.codemirror.focus(),"end"==store.get("appSettings.cursor")&&easymde.codemirror.setCursor(easymde.codemirror.lineCount(),0);else{if(easymde.codemirror.historySize().undo>0){if(0===dialog.showMessageBox(remote.getCurrentWindow(),{message:i18n.t("app:dialog.save.title","You have made changes to this note"),detail:i18n.t("app:dialog.save.text","Do you want to save them?"),buttons:[i18n.t("app:dialog.button.savechanges","Save changes"),i18n.t("app:dialog.button.cancel","Cancel")]})){let t=easymde.value();easymde.codemirror.clearHistory(),apiCall("save",e,{content:t,modified:Math.floor(Date.now()/1e3)})}else for(;easymde.codemirror.historySize().undo>0;)easymde.codemirror.undo()}easymde.togglePreview(),$("#edit").attr("title",i18n.t("app:main.button.edit","Edit Note")).removeClass("editing").focus()}}function saveNote(e){if(!easymde.isPreviewActive()&&easymde.codemirror.historySize().undo>0){console.log("SAVING!!"),apiCall("save",e,{content:easymde.value(),modified:Math.floor(Date.now()/1e3)})}}function exportNote(e){const t=store.get("exportPath");dialog.showSaveDialog(remote.getCurrentWindow(),{defaultPath:`${t}/${e.title}`,buttonLabel:i18n.t("app:dialog.button.export","Export Note"),properties:["openDirectory","createDirectory"],filters:[{name:i18n.t("app:dialog.format.html","html"),extensions:["html"]},{name:i18n.t("app:dialog.format.md","markdown"),extensions:["md"]},{name:i18n.t("app:dialog.format.txt","text"),extensions:["txt"]}]},function(t){let a,o;switch(t.split(".").pop()){case"html":let r=marked(e.content);a=pretty(`<!doctype html><html lang="en"><head><meta charset="utf-8" /><title>${e.title}</title></head><body>${r}</body></html>`,{ocd:!0}),o="html";break;case"txt":a=removeMarkdown(e.content),o="text";break;default:a=e.content,o="markdown"}fs.outputFile(t,a).then(()=>fs.readFile(t,"utf8")).then(t=>{new Notification("Nextcloud Notes Client",{body:i18n.t("app:notification.export.text","The note {{title}} has been exported as {{filetype}}",{title:e.title,filetype:o})})}).catch(e=>{console.error(e)})})}function deleteCheck(e){0===dialog.showMessageBox(remote.getCurrentWindow(),{message:i18n.t("app:dialog.delete.title","Are you sure you want to delete this note?"),detail:i18n.t("app:dialog.delete.text","This operation is not reversable."),buttons:[i18n.t("app:dialog.button.delete","Delete Note"),i18n.t("app:dialog.button.cancel","Cancel")]})&&apiCall("delete",e)}function applyZoom(e){$(".editor-preview").css({"font-size":`${e/10}rem`})}function toggleSpellcheck(e){e?$(".CodeMirror").addClass("spellcheck"):$(".CodeMirror").removeClass("spellcheck")}function toggleCursorPosition(e){alert(e)}function openModal(e,t,a,o){(modal=new remote.BrowserWindow({parent:remote.getCurrentWindow(),modal:!0,width:t,minWidth:t,maxWidth:t,height:a,minHeight:a,resizable:o,show:!1,backgroundColor:"#ececec",webPreferences:{nodeIntegration:!0}})).loadURL(e),modal.once("ready-to-show",()=>{modal.show()})}dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat",i18n.t("date:sunday","Sunday"),i18n.t("date:monday","Monday"),i18n.t("date:tuesday","Tuesday"),i18n.t("date:wednesday","Wednesday"),i18n.t("date:thursday","Thursday"),i18n.t("date:friday","Friday"),i18n.t("date:saturday","Saturday")],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec",i18n.t("date:january","January"),i18n.t("date:february","February"),i18n.t("date:march","March"),i18n.t("date:april","April"),i18n.t("date:may","May"),i18n.t("date:june","June"),i18n.t("date:july","July"),i18n.t("date:august","August"),i18n.t("date:september","September"),i18n.t("date:august","October"),i18n.t("date:november","November"),i18n.t("date:december","December")],timeNames:["a","p","am","pm","A","P","AM","PM"]},ipcRenderer.on("set-zoom-slider",(e,t)=>{applyZoom(t)}),ipcRenderer.on("reload-sidebar",()=>{$("#sidebar").html(""),apiCall("all")}),ipcRenderer.on("spellcheck",(e,t)=>{toggleSpellcheck(t)}),ipcRenderer.on("open-login-modal",(e,t)=>{openModal("file://"+__dirname+"/../html/login.html",480,180,!1)}),ipcRenderer.on("close-login-modal",(e,t)=>{modal.close()}),ipcRenderer.on("note",(e,t)=>{let a=store.get("appInterface.selected");switch(t){case"new":apiCall("new",null,{content:"# "+i18n.t("app:sidebar.new","New note")});break;case"edit":a&&editNote(a);break;case"save":a&&saveNote(a);break;case"favorite":if(a){apiCall("update",a,{favorite:"true"!=$(`#sidebar li button[data-id="${a}"]`).attr("data-favorite")})}break;case"export":a&&apiCall("export",a);break;case"delete":a&&deleteCheck(a)}}),ipcRenderer.on("markdown",(e,t)=>{if(!easymde.isPreviewActive())switch(t){case"h1":easymde.toggleHeading1();break;case"h2":easymde.toggleHeading2();break;case"h3":easymde.toggleHeading3();break;case"h4":easymde.toggleHeading4();break;case"h5":easymde.toggleHeading5();break;case"h6":easymde.toggleHeading6();break;case"b":easymde.toggleBold();break;case"i":easymde.toggleItalic();break;case"del":easymde.toggleStrikethrough();break;case"ul":easymde.toggleUnorderedList();break;case"ol":easymde.toggleOrderedList();break;case"a":easymde.drawLink();break;case"img":easymde.drawImage();break;case"code":easymde.toggleCodeBlock();break;case"blockquote":easymde.toggleBlockquote();break;case"table":easymde.drawTable();break;case"hr":easymde.drawHorizontalRule()}}),ipcRenderer.on("html",(e,t)=>{if(!easymde.isPreviewActive())switch(t){case"small":case"sup":case"sub":case"u":case"mark":wrapTextToSelection(`<${t}>`,`</${t}>`);break;case"dl":insertTextAtCursor(`<dl>\n\t<dt>${i18n.t("app:main.title","title")}</dt>\n\t<dd>${i18n.t("app:main.description","description")}</dd>\n\t<dt>${i18n.t("app:main.title","title")}</dt>\n\t<dd>${i18n.t("app:main.description","description")}</dd>\n</dl>`)}}),ipcRenderer.on("set-zoom-level",(e,t)=>{let a=store.get("appSettings.zoom");switch(t){case 1:++a>16&&(a=16);break;case-1:--a<4&&(a=4);break;default:a=10}store.set("appSettings.zoom",a),applyZoom(a)}),ipcRenderer.on("context-favorite",(e,t)=>{let a="true"!=t.favorite;apiCall("update",t.id,{favorite:a})}),ipcRenderer.on("context-export",(e,t)=>{apiCall("export",t)}),ipcRenderer.on("context-delete",(e,t)=>{deleteCheck(t)}),$("body").on("click","#sidebar li button",function(e){e.stopPropagation();let t=$(this).data("id");$("#time").html(""),$("#note").html('<div class="loader"></div>'),$("#sidebar li button").removeClass("selected").removeClass("above-selected"),$(this).addClass("selected").parent().prev().children().addClass("above-selected"),apiCall("single",t),store.set("appInterface.selected",t)}),$("body").on("mouseup","#sidebar li button",function(e){e.stopPropagation();let t={id:$(this).data("id"),title:$(this).data("title"),favorite:$(this).attr("data-favorite")};3!==e.which||ipcRenderer.send("show-sidebar-menu",t)}),$("body").on("focus","#sidebar li button",function(e){$(this).parent().prev().children().addClass("above-selected")}),$("body").on("focusout","#sidebar li button",function(e){$(this).hasClass("selected")||$(this).parent().prev().children().removeClass("above-selected")}),$("body").on("mouseup","aside",function(e){3===e.which&&ipcRenderer.send("show-sidebar-menu",null)}),$("body").on("click",".editor-preview a",e=>{e.preventDefault();let t=e.target.href;"file"!==t.substr(0,4)&&shell.openExternal(t)}),$(document).ready(function(){$("html").attr("lang",i18n.language),toggleSpellcheck(store.get("appSettings.spellcheck")),$("#edit").attr("title",i18n.t("app:main.button.edit","Edit Note")),server&&username&&password?apiCall("all"):openModal("file://"+__dirname+"/../html/login.html",480,180,!1),$("#edit").click(function(){editNote()})});
//# sourceMappingURL=maps/app.min.js.map
