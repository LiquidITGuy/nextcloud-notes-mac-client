"use strict";const i18n=require("./i18n.min"),{ipcRenderer:ipcRenderer,shell:shell,remote:remote}=require("electron"),Store=require("electron-store"),store=new Store,dialog=remote.dialog,$=require("jquery"),removeMarkdown=require("remove-markdown"),EasyMDE=require("easymde"),hljs=require("highlight.js"),entities=require("html-entities").AllHtmlEntities,log=require("electron-log"),fetch=require("./fetch.min"),dates=require("./dates.min"),editor=require("./editor.min"),modalWindow=require("./modal.min"),sanitize=require("./sanitize-category.min"),search=require("./search.min");let server=store.get("loginCredentials.server"),username=store.get("loginCredentials.username"),password=store.get("loginCredentials.password"),easymde=new EasyMDE(editor.easymdeSetup),firstLoad=!0,database=new Store({name:"database",notes:{}});function fetchResult(e,t,a,o){switch(e){case"new":store.set("appInterface.selected",o.id),fetch.apiCall("all",null,null,(function(e,t,a,o){fetchResult(e,t,a,o)}));break;case"save":fetch.apiCall("sidebar",null,null,(function(e,t,a,o){fetchResult(e,t,a,o)}));break;case"update":$(`button[data-id="${t}"]`).removeData("favorite"),$(`button[data-id="${t}"]`).attr("data-favorite",a.favorite);break;case"category":fetch.apiCall("sidebar",null,null,(function(e,t,a,o){fetchResult(e,t,a,o)}));break;case"delete":$("#sidebar li button.selected").attr("data-id")==t&&(resetEditor(),store.set("appInterface.selected",null),$("#note").attr("data-id",null),$("#time, #note").html("")),fetch.apiCall("all",null,null,(function(e,t,a,o){fetchResult(e,t,a,o)}));break;case"export":require("./export.min").exportNote(o);break;case"sidebar":listNotes(o,"sidebar");break;default:t?displayNote(o):listNotes(o)}}function resetEditor(){easymde.codemirror.setValue(""),easymde.value(""),$(".editor-preview").html("")}function insertTextAtCursor(e){let t=easymde.codemirror.getDoc(),a=t.getCursor();t.replaceRange(e,a)}function wrapTextToSelection(e,t){let a=easymde.codemirror.getDoc(),o=a.getSelection();a.replaceSelection(e+o+t)}function wrapBlockToCursor(e,t){let a=easymde.codemirror.getDoc(),o=a.getCursor();a.replaceRange(`${e}\n\n${t}`,o);let s=(o=a.getCursor()).line-1;a.setCursor({line:s})}function saveCategories(e){let t=[],a=e.slice(0),o=store.get("appSettings.ordercats"),s=[];null==o&&(o="asc"),$("#categories").empty().addClass(o);for(var i=0;i<e.length;i++){for(var r=0,n=0;n<a.length;n++)e[i]==a[n]&&(r++,delete a[n]);if(r>0){var c=new Object;c.value=e[i],c.count=r,t.push(c)}}t.length>1&&t.sort((function(e,t){var a=e.value,o=t.value;return a<o?-1:a>o?1:0}));for(let e of t){let t=e.value,a=e.count,o=sanitize.sanitizeCategory(t),i=store.get("appSettings.catcount")?" show":"";t.length>0&&(s.push({item:t,catID:o,count:a}),$("#categories").append(`<li><button class="custom" data-catid="${o}" data-category="${t}" title="${t}"><span class="cat-name">${t}</span><span class="cat-count${i}">${a}</span></button></li>`))}$(`.categories button[data-catid="${store.get("categories.selected")}"]`).addClass("selected"),showHideCategoryIcons(),store.set("categories.list",s)}function showHideCategoryIcons(){$(".categories button.selected").hasClass("custom")?$("#sidebar").addClass("hidecats"):$("#sidebar").removeClass("hidecats")}function listNotes(e,t){null!==t&&database.set("notes",e);let a=store.get("appSettings.sortby"),o=store.get("appSettings.orderby"),s="",i=[];e.length>1&&e.sort((function(e,t){var s=e[a],i=t[a];return"asc"===o?s<i?-1:s>i?1:0:s>i?-1:s<i?1:0}));for(let t of e)s+=addSidebarEntry(t),i.push(t.category);$("#sidebar").html(s),t?getSelected("sidebar"):getSelected(),saveCategories(i),selectCategory(store.get("categories.selected"))}function addSidebarEntry(e){let t=new Date(e.modified),a=dates.sidebarDate(t.getTime()),o=e.category?sanitize.sanitizeCategory(e.category):"##none##",s=e.category?e.category:i18n.t("app:categories.none","Uncategorised"),i=removeMarkdown(e.content.replace(/(!\[.*\]\(.*\)|<[^>]*>|>|<)/g,""));return i=i?i.substr(0,120).slice(e.title.length):i18n.t("app:sidebar.notext","No additional text"),`<li data-id="${e.id}">\n\t\t\t\t\t<button data-id="${e.id}" data-title="${e.title}" data-content="" data-catid="${o}" data-category="${e.category}" data-favorite="${e.favorite}">\n\t\t\t\t\t\t<span class="side-title">${e.title}</span>\n\t\t\t\t\t\t<span class="side-text">${a}&nbsp;&nbsp;<span class="excerpt">${i}</span></span>\n\t\t\t\t\t\t<span class="side-cat">${s}</span>\n\t\t\t\t\t</button>\n\t\t\t\t</li>`}function displayNote(e){if($("#edit").removeClass("editing"),$("#time").html(dates.titlebarDate(e.modified)),easymde&&(easymde.toTextArea(),easymde=null),easymde=new EasyMDE(editor.easymdeSetup),toggleSpellcheck(store.get("appSettings.spellcheck")),easymde.codemirror.on("mousedown",(function(e,t){if(3!==t.which);else{let e=easymde.codemirror.doc.getSelection();ipcRenderer.send("show-notes-menu",{selection:e,preview:!1})}})),$("#note").attr("data-id",e.id),easymde.value(e.content),easymde.codemirror.clearHistory(),easymde.togglePreview(),setCheckLists(),$("time").fadeIn("fast"),$(".loader").fadeOut(400,(function(){$(this).remove()})),!0===firstLoad){const e=require("./version.min");firstLoad=1,e.appVersion((function(e){displayVersion(e)}))}}function displayVersion(e){$("header").append(e),$(".fadein").fadeIn("slow")}function getSelected(e){let t=store.get("appInterface.selected");t&&($(`button[data-id="${t}"]`).addClass("selected").parent().prev().children().addClass("above-selected"),e||fetch.apiCall("single",t,null,(function(e,t,a,o){fetchResult(e,t,a,o)})))}function editNote(){let e=store.get("appInterface.selected");if(e)if(easymde.isPreviewActive())$("#edit").attr("title",i18n.t("app:main.button.save","Save Note")).addClass("editing"),easymde.togglePreview(),easymde.codemirror.focus(),initCheckboxes(),easymde.codemirror.on("changes",initCheckboxes),"end"==store.get("appSettings.cursor")&&easymde.codemirror.setCursor(easymde.codemirror.lineCount(),0);else{if(easymde.codemirror.historySize().undo>0){if(0===dialog.showMessageBoxSync(remote.getCurrentWindow(),{message:i18n.t("app:dialog.save.title","You have made changes to this note"),detail:i18n.t("app:dialog.save.text","Do you want to save them?"),buttons:[i18n.t("app:dialog.button.savechanges","Save changes"),i18n.t("app:dialog.button.cancel","Cancel")]})){let t={content:easymde.value(),modified:Math.floor(Date.now()/1e3)};easymde.codemirror.clearHistory(),fetch.apiCall("save",e,t,(function(e,t,a,o){fetchResult(e,t,a,o)}))}else for(;easymde.codemirror.historySize().undo>0;)easymde.codemirror.undo()}easymde.togglePreview(),$("#edit").attr("title",i18n.t("app:main.button.edit","Edit Note")).removeClass("editing").focus(),setCheckLists()}}function initCheckboxes(){$(".cm-formatting-task").off("click.toggleEditorCheckboxes").on("click.toggleEditorCheckboxes",(function(e){$(".cm-formatting-task").off("click.toggle_checkbox"),e.stopPropagation(),e.preventDefault(),toggleEditorCheckboxes($(this))}))}function toggleEditorCheckboxes(e){let t=easymde.codemirror.getDoc(),a=e.parents(".CodeMirror-line").index(),o=t.getLineHandle(a),s="[x]"==e.text()?"[ ]":"[x]";t.replaceRange(s,{line:a,ch:o.text.indexOf("[")},{line:a,ch:o.text.indexOf("]")+1}),easymde.codemirror.execCommand("goLineEnd")}function saveNote(e){if(!easymde.isPreviewActive()&&easymde.codemirror.historySize().undo>0){let t={content:easymde.value(),modified:Math.floor(Date.now()/1e3)};easymde.codemirror.clearHistory(),fetch.apiCall("save",e,t,(function(e,t,a,o){fetchResult(e,t,a,o)}))}}function deleteCheck(e){0===dialog.showMessageBoxSync(remote.getCurrentWindow(),{message:i18n.t("app:dialog.delete.title","Are you sure you want to delete this note?"),detail:i18n.t("app:dialog.delete.text","This operation is not reversable."),buttons:[i18n.t("app:dialog.button.delete","Delete Note"),i18n.t("app:dialog.button.cancel","Cancel")]})&&fetch.apiCall("delete",e,null,(function(e,t,a,o){fetchResult(e,t,a,o)}))}function applyZoom(e){$(".editor-preview").css({"font-size":`${e/10}rem`})}function toggleSpellcheck(e){e?$(".CodeMirror").addClass("spellcheck"):$(".CodeMirror").removeClass("spellcheck")}function toggleCategories(e){$("#sidebar").toggleClass("showcats")}function capitalize(e){return e.replace(/(?:^|\s)\S/g,(function(e){return e.toLocaleUpperCase(i18n.language)}))}function selectCategory(e){switch($("#search").val(""),$("#clear").hide(),$("#result").empty().hide(),e){case"##all##":$("#sidebar li").show();break;case"##fav##":$("#sidebar li").hide(),$("#sidebar button[data-favorite='true']").parent("li").show();break;default:$("#sidebar li").hide(),$(`#sidebar button[data-catid='${e}']`).parent("li").show()}}function setCheckLists(){$('input[type="checkbox"]').parent().css("list-style-type","none")}function searchResult(e,t){$("#sidebar li").hide(),$("#result").html(t).show();for(let t of e)$(`#sidebar li[data-id='${t}']`).show()}window.onerror=function(e,t,a){ipcRenderer.send("error-in-render",{error:e,url:t,line:a})},ipcRenderer.on("set-zoom-slider",(e,t)=>{applyZoom(t)}),ipcRenderer.on("reload-sidebar",(e,t)=>{"login"===t?(server=store.get("loginCredentials.server"),username=store.get("loginCredentials.username"),password=store.get("loginCredentials.password"),log.info(`${t} completed`),fetch.apiCall("all",null,null,(function(e,t,a,o){fetchResult(e,t,a,o)}))):"logout"===t?(server=username=password=null,resetEditor(),$("#sidebar, #categories").empty()):fetch.apiCall("sidebar",null,null,(function(e,t,a,o){fetchResult(e,t,a,o)}))}),ipcRenderer.on("spellcheck",(e,t)=>{let a=!t;store.set("appSettings.spellcheck",a),toggleSpellcheck(a)}),ipcRenderer.on("showcats",(e,t)=>{toggleCategories(t)}),ipcRenderer.on("set-theme",(e,t)=>{__setTheme()}),ipcRenderer.on("toggle-categories",(e,t)=>{$("#frame, footer").toggleClass("slide");let a=!store.get("appInterface.categories");store.set("appInterface.categories",a)}),ipcRenderer.on("toggle-catcount",(e,t)=>{$(".cat-count").toggleClass("show");let a=!store.get("appSettings.catcount");store.set("appSettings.catcount",a)}),ipcRenderer.on("toggle-caticons",(e,t)=>{$("#sidebar").toggleClass("showcats");let a=!store.get("appSettings.showcats");store.set("appSettings.showcats",a)}),ipcRenderer.on("open-login-modal",(e,t)=>{modalWindow.openModal("file://"+__dirname+"/../html/login.html",480,210,!1)}),ipcRenderer.on("close-login-modal",(e,t)=>{modalWindow.closeModal}),ipcRenderer.on("note",(e,t)=>{let a=store.get("appInterface.selected");switch(t){case"new":let e;switch(store.get("categories.selected")){case"##all##":case"##none##":e={content:"# "+i18n.t("app:sidebar.new","New note")};break;case"##fav##":e={content:"# "+i18n.t("app:sidebar.new","New note"),favorite:!0};break;default:e={content:"# "+i18n.t("app:sidebar.new","New note"),category:$(".categories li button.selected").data("category")}}fetch.apiCall("new",null,e,(function(e,t,a,o){fetchResult(e,t,a,o)}));break;case"edit":a&&editNote(a);break;case"save":a&&saveNote(a);break;case"favorite":if(a){let e="true"!=$(`#sidebar li button[data-id="${a}"]`).attr("data-favorite");fetch.apiCall("update",a,{favorite:e},(function(e,t,a,o){fetchResult(e,t,a,o)}))}break;case"newcat":a&&modalWindow.openModal("file://"+__dirname+`/../html/new-category.html?id=${a}`,480,180,!1);break;case"export":a&&fetch.apiCall("export",a,null,(function(e,t,a,o){fetchResult(e,t,a,o)}));break;case"delete":a&&deleteCheck(a);break;case"selectall":easymde.isPreviewActive()?$("#search:focus")&&$("#search").select():easymde.codemirror.execCommand("selectAll");break;case"find":!1===store.get("appInterface.categories")&&($("#frame, footer").addClass("slide"),store.set("appInterface.categories",!0)),$("#search").focus()}}),ipcRenderer.on("markdown",(e,t)=>{if(!easymde.isPreviewActive())switch(t){case"h1":easymde.toggleHeading1();break;case"h2":easymde.toggleHeading2();break;case"h3":easymde.toggleHeading3();break;case"h4":easymde.toggleHeading4();break;case"h5":easymde.toggleHeading5();break;case"h6":easymde.toggleHeading6();break;case"b":easymde.toggleBold();break;case"i":easymde.toggleItalic();break;case"del":easymde.toggleStrikethrough();break;case"ul":easymde.toggleUnorderedList();break;case"ol":easymde.toggleOrderedList();break;case"cl":easymde.codemirror.replaceSelection("- [ ]  "),easymde.codemirror.focus();break;case"a":easymde.drawLink();break;case"img":easymde.drawImage();break;case"code":easymde.toggleCodeBlock();break;case"blockquote":easymde.toggleBlockquote();break;case"table":easymde.drawTable();break;case"hr":easymde.drawHorizontalRule()}}),ipcRenderer.on("html",(e,t)=>{if(!easymde.isPreviewActive())switch(t){case"small":case"sup":case"sub":case"u":case"mark":wrapTextToSelection(`<${t}>`,`</${t}>`);break;case"javascript":case"json":case"html":case"css":case"scss":case"php":case"objective-c":case"c-like":case"bash":wrapBlockToCursor(`\`\`\` ${t}`,"```");break;case"dl":insertTextAtCursor(`<dl>\n\t<dt>${i18n.t("app:main.title","title")}</dt>\n\t<dd>${i18n.t("app:main.description","description")}</dd>\n\t<dt>${i18n.t("app:main.title","title")}</dt>\n\t<dd>${i18n.t("app:main.description","description")}</dd>\n</dl>`)}}),ipcRenderer.on("set-zoom-level",(e,t)=>{let a=store.get("appSettings.zoom");switch(t){case 1:++a>16&&(a=16);break;case-1:--a<4&&(a=4);break;default:a=10}store.set("appSettings.zoom",a),applyZoom(a)}),ipcRenderer.on("context-favorite",(e,t)=>{let a="true"!=t.favorite,o=t.id;fetch.apiCall("update",o,{favorite:a},(function(e,t,a,o){fetchResult(e,t,a,o)}))}),ipcRenderer.on("context-export",(e,t)=>{fetch.apiCall("export",t,null,(function(e,t,a,o){fetchResult(e,t,a,o)}))}),ipcRenderer.on("context-delete",(e,t)=>{deleteCheck(t)}),ipcRenderer.on("context-category",(e,t)=>{let a=parseInt(t.id),o=t.category,s=database.get("notes").find(e=>e.id===a),i={modified:s.modified,content:s.content,category:o};fetch.apiCall("category",a,i,(function(e,t,a,o){fetchResult(e,t,a,o)}))}),ipcRenderer.on("context-newcategory",(e,t)=>{modalWindow.openModal("file://"+__dirname+`/../html/new-category.html?id=${t}`,480,180,!1)}),ipcRenderer.on("category-order",(e,t)=>{store.set("appSettings.ordercats",t),$("#categories").removeClass("asc desc").addClass(t)}),ipcRenderer.on("context-note-encode",(e,t)=>{let a=entities.encode(t);easymde.codemirror.doc.replaceSelection(a)}),ipcRenderer.on("context-note-decode",(e,t)=>{let a=entities.decode(t);easymde.codemirror.doc.replaceSelection(a)}),ipcRenderer.on("context-note-upper",(e,t)=>{easymde.codemirror.doc.replaceSelection(t.toLocaleUpperCase(i18n.language))}),ipcRenderer.on("context-note-lower",(e,t)=>{easymde.codemirror.doc.replaceSelection(t.toLocaleLowerCase(i18n.language))}),ipcRenderer.on("context-note-caps",(e,t)=>{let a=t.toLocaleLowerCase(i18n.language);easymde.codemirror.doc.replaceSelection(capitalize(a))}),$("body").on("click","#sidebar li button",(function(e){e.stopPropagation();let t=$(this).data("id");$("#time").empty().hide(),$("main").append('<div class="loader"><div class="spinner"></div></div>'),$("#sidebar li button").removeClass("selected").removeClass("above-selected"),$(this).addClass("selected").parent().prev().children().addClass("above-selected"),fetch.apiCall("single",t,null,(function(e,t,a,o){fetchResult(e,t,a,o)})),store.set("appInterface.selected",t)})),$("body").on("mouseup","#sidebar li button",(function(e){e.stopPropagation();let t={id:$(this).data("id"),title:$(this).data("title"),favorite:$(this).attr("data-favorite"),category:$(this).attr("data-category"),catID:$(this).attr("data-catid")};3!==e.which||ipcRenderer.send("show-sidebar-menu",t)})),$("body").on("focus","#sidebar li button",(function(e){$(this).parent().prev().children().addClass("above-selected")})),$("body").on("focusout","#sidebar li button",(function(e){$(this).hasClass("selected")||$(this).parent().prev().children().removeClass("above-selected")})),$("body").on("mouseup","aside",(function(e){3===e.which&&ipcRenderer.send("show-sidebar-menu",null)})),$("body").on("mouseup",".editor-preview-active",(function(e){3===e.which&&ipcRenderer.send("show-notes-menu",{selection:"",preview:!0})})),$(document).on("click",'a[href^="http"]',(function(e){e.preventDefault(),shell.openExternal(this.href)})),$("body").on("click",".categories button",(function(e){$(this).attr("data-category");let t=$(this).attr("data-catid");$(".categories button").removeClass("selected"),$(this).addClass("selected"),store.set("categories.selected",t),selectCategory(t),showHideCategoryIcons()})),document.addEventListener("keydown",(function(e){if(easymde.isPreviewActive()){let t;switch(e.which){case 13:$(":focus").click().focus();break;case 38:$("#sidebar button").blur(),(t=$("#sidebar button.selected").parent("li").prevAll("li:visible")).first().find("button").click().focus();break;case 40:$("#sidebar button").blur(),(t=$("#sidebar button.selected").parent("li").nextAll("li:visible")).first().find("button").click().focus()}}})),$("body").on("click","#update",e=>{e.preventDefault();let t=$("#update").attr("data-url");shell.openExternal(t)}),$("body").on("mouseenter","main a",(function(){$("#location").empty().html(this.href),$("samp").addClass("show")})),$("body").on("mouseleave","main a",(function(){$("samp").removeClass("show")})),$("#search").bind("keyup",(function(){let e=$(this).val();$("#clear"),e.length>0?$("#clear").show():$("#clear").hide();search.searchNotes(e,(function(e,t){searchResult(e,t)}))})),$("#clear").click((function(){$("#search").val(""),$("#result").empty().hide(),selectCategory(store.get("categories.selected")),$(".categories button.selected").focus(),$(this).hide()})),$(document).ready((function(){$("html").attr("lang",i18n.language),store.get("appSettings.showcats")&&$("#sidebar").addClass("showcats"),store.get("appInterface.categories")&&$("#frame, footer").addClass("slide"),store.get("appSettings.catcount")&&$(".cat-count").addClass("show"),$("#edit").attr("title",i18n.t("app:main.button.edit","Edit Note")),$("#cat-title").html(i18n.t("app:categories.title","Categories")),$("#cat-all").html(i18n.t("app:categories.all","All notes")),$("#cat-all").attr("title",i18n.t("app:categories.all","All notes")),$("#cat-fav").html(i18n.t("app:categories.fav","Favorites")),$("#cat-fav").attr("title",i18n.t("app:categories.fav","Favorites")),$("#cat-none").html(i18n.t("app:categories.none","Uncategorised")),$("#cat-none").attr("title",i18n.t("app:categories.none","Uncategorised")),$("#search").attr("placeholder",i18n.t("app:sidebar.search","Search")),server&&username&&password?fetch.apiCall("all",null,null,(function(e,t,a,o){fetchResult(e,t,a,o)})):modalWindow.openModal("file://"+__dirname+"/../html/login.html",480,210,!1),$("#edit").click((function(){editNote()}))}));
//# sourceMappingURL=maps/app.min.js.map
