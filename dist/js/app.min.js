"use strict";const{ipcRenderer:ipcRenderer,shell:shell}=require("electron"),Store=require("electron-store"),store=new Store,{remote:remote}=require("electron"),dialog=remote.dialog,dateFormat=require("dateformat"),$=require("jquery"),marked=require("marked"),removeMarkdown=require("remove-markdown"),pretty=require("pretty"),fs=require("fs-extra"),server=store.get("loginCredentials.server"),username=store.get("loginCredentials.username"),password=store.get("loginCredentials.password");let modal;const SimpleMDE=require("simplemde");let smeSetup={element:$("#note")[0],autofocus:!1,forceSync:!0,status:!1,spellChecker:!0,toolbar:["heading","|","bold","italic","strikethrough","|","unordered-list","ordered-list","|","link","image","|","code","quote","table","horizontal-rule"],shortcuts:{toggleStrikethrough:"Cmd-Alt-D",toggleBlockquote:"Cmd-'",drawTable:"Cmd-T",drawHorizontalRule:"Cmd--",cleanBlock:null,toggleSideBySide:null,toggleFullScreen:null,togglePreview:null}},simplemde=new SimpleMDE(smeSetup);function apiCall(e,t,o){let r;switch(e){case"new":r="post";break;case"save":case"update":r="put";break;case"delete":r="delete";break;default:r="get"}let a="/index.php/apps/notes/api/v0.2/notes",i={method:r,headers:{Authorization:"Basic "+btoa(username+":"+password),"Content-Type":"application/json"},mode:"cors",cache:"no-store"};t&&(a+=`/${t}`),o&&(i.body=JSON.stringify(o)),console.log(`URL: ${a}`),fetch(server+a,i).then(function(e){if(e.ok)return console.log("response OK"),e.text();dialog.showErrorBox(" Server connection error",`there was an error connecting to:\n${server}`),console.log(e.error())}).then(function(r){let a=JSON.parse(r);if("error"==a.status)dialog.showErrorBox("JSON parsing error","An error occured parsing the notes"),console.log(a.message);else switch(e){case"new":store.set("appInterface.selected",a.id),$("#sidebar").html(""),apiCall("all");break;case"save":$("#sidebar").html(""),apiCall("sidebar");break;case"update":$(`button[data-id="${t}"]`).removeData("favorite"),$(`button[data-id="${t}"]`).attr("data-favorite",o.favorite);break;case"delete":$("#sidebar li button.selected").attr("data-id")==t&&(resetEditor(),store.set("appInterface.selected",null),$("#note").attr("data-id",null),$("#time, #note").html("")),$("#sidebar").html(""),apiCall("all");break;case"export":exportNote(a);break;case"sidebar":listNotes(a,"sidebar");break;default:t?displayNote(a):listNotes(a)}}).catch(function(e){dialog.showErrorBox("Server connection error",`there was an error connecting to:\n${server}`),console.log(e)})}function resetEditor(){simplemde.codemirror.setValue(""),simplemde.value(""),$(".editor-preview").html("")}function insertTextAtCursor(e){let t=simplemde.codemirror.getDoc(),o=t.getCursor();t.replaceRange(e,o)}function wrapTextToSelection(e,t){let o=simplemde.codemirror.getDoc(),r=o.getSelection();o.replaceSelection(e+r+t)}function listNotes(e,t){const o=(new Date).getTime()/1e3;let r=store.get("appSettings.sortby"),a=store.get("appSettings.orderby");e.length>1&&e.sort(function(e,t){var o=e[r],i=t[r];return"asc"===a?o<i?-1:o>i?1:0:o>i?-1:o<i?1:0});for(let t of e){let e=formatDate(o,new Date(t.modified).getTime()),r=removeMarkdown(t.content.replace(/(!\[.*\]\(.*\)|<[^>]*>|>|<)/g,""));r=r?r.substr(0,120).slice(t.title.length):"No additional text",$("#sidebar").append(`<li>\n\t\t\t<button data-id="${t.id}" data-title="${t.title}" data-category="${t.category}" data-favorite="${t.favorite}">\n\t\t\t\t<span class="side-title">${t.title}</span>\n\t\t\t\t<span class="side-text">${e}&nbsp;&nbsp;${r}</span>\n\t\t\t</button>\n\t\t</li>\n\t\t`)}t?getSelected("sidebar"):getSelected()}function formatDate(e,t){return dateFormat(1e3*t,e-86400<t?"H:MM":e-604800<t?"dddd":"dd/mm/yy")}function displayNote(e){$(".CodeMirror-code").addClass("hide"),$("#edit").removeClass("editing"),$("#time").html(dateFormat(1e3*e.modified,'d mmmm, yyyy "at" HH:MM')),resetEditor(),simplemde.isPreviewActive()&&simplemde.togglePreview(),$("#note").attr("data-id",e.id),simplemde.value(e.content),simplemde.codemirror.clearHistory(),simplemde.togglePreview(),applyZoom(store.get("appSettings.zoom")),$(".CodeMirror-code").removeClass("hide")}function getSelected(e){let t=store.get("appInterface.selected");t&&($(`button[data-id="${t}"]`).addClass("selected").parent().prev().children().addClass("above-selected"),e||apiCall("single",t))}function editNote(){let e=store.get("appInterface.selected");if(e)if(simplemde.isPreviewActive())$("#edit").addClass("editing"),simplemde.togglePreview(),simplemde.codemirror.focus(),"end"==store.get("appSettings.cursor")&&simplemde.codemirror.setCursor(simplemde.codemirror.lineCount(),0);else{if(simplemde.codemirror.historySize().undo>0){if(0===dialog.showMessageBox(remote.getCurrentWindow(),{message:"You have made changes to this note",detail:"Do you want to save them?",buttons:["Save changes","Cancel"]})){let t=simplemde.value();simplemde.codemirror.clearHistory(),apiCall("save",e,{content:t,modified:Math.floor(Date.now()/1e3)})}else for(;simplemde.codemirror.historySize().undo>0;)simplemde.codemirror.undo()}simplemde.togglePreview(),$("#edit").removeClass("editing").focus()}}function saveNote(e){if(!simplemde.isPreviewActive()&&simplemde.codemirror.historySize().undo>0){console.log("SAVING!!"),apiCall("save",e,{content:simplemde.value(),modified:Math.floor(Date.now()/1e3)})}}function exportNote(e){const t=store.get("exportPath");dialog.showSaveDialog(remote.getCurrentWindow(),{defaultPath:`${t}/${e.title}`,buttonLabel:"Export Note",properties:["openDirectory","createDirectory"],filters:[{name:"html",extensions:["html"]},{name:"markdown",extensions:["md"]},{name:"text",extensions:["txt"]}]},function(t){let o,r;switch(t.split(".").pop()){case"html":let a=marked(e.content);o=pretty(`<!doctype html><html lang="en"><head><meta charset="utf-8" /><title>${e.title}</title></head><body>${a}</body></html>`,{ocd:!0}),r="html";break;case"txt":o=removeMarkdown(e.content),r="text";break;default:o=e.content,r="markdown"}fs.outputFile(t,o).then(()=>fs.readFile(t,"utf8")).then(t=>{new Notification("Nextcloud Notes Client",{body:`The note ${e.title} has been exported as ${r}.`})}).catch(e=>{console.error(e)})})}function deleteCheck(e){0===dialog.showMessageBox(remote.getCurrentWindow(),{message:"Are you sure you want to delete this note?",detail:"This operation is not reversable.",buttons:["Delete Note","Cancel"]})&&apiCall("delete",e)}function applyZoom(e){$(".editor-preview").css({"font-size":`${e/10}rem`})}function toggleSpellcheck(e){e?$(".CodeMirror").addClass("spellcheck"):$(".CodeMirror").removeClass("spellcheck")}function toggleCursorPosition(e){alert(e)}function openModal(e,t,o,r){(modal=new remote.BrowserWindow({parent:remote.getCurrentWindow(),modal:!0,width:t,minWidth:t,maxWidth:t,height:o,minHeight:o,resizable:r,show:!1,backgroundColor:"#ececec",webPreferences:{nodeIntegration:!0}})).loadURL(e),modal.once("ready-to-show",()=>{modal.show()})}ipcRenderer.on("set-zoom-slider",(e,t)=>{applyZoom(t)}),ipcRenderer.on("reload-sidebar",()=>{$("#sidebar").html(""),apiCall("all")}),ipcRenderer.on("spellcheck",(e,t)=>{toggleSpellcheck(t)}),ipcRenderer.on("open-login-modal",(e,t)=>{openModal("file://"+__dirname+"/../html/login.html",480,180,!1)}),ipcRenderer.on("close-login-modal",(e,t)=>{modal.close()}),ipcRenderer.on("note",(e,t)=>{let o=store.get("appInterface.selected");switch(t){case"new":apiCall("new",null,{content:"# New note"});break;case"edit":o&&editNote(o);break;case"save":o&&saveNote(o);break;case"favorite":if(o){apiCall("update",o,{favorite:"true"!=$(`#sidebar li button[data-id="${o}"]`).attr("data-favorite")})}break;case"export":o&&apiCall("export",o);break;case"delete":o&&deleteCheck(o)}}),ipcRenderer.on("markdown",(e,t)=>{if(!simplemde.isPreviewActive())switch(t){case"h1":simplemde.toggleHeading1();break;case"h2":simplemde.toggleHeading2();break;case"h3":simplemde.toggleHeading3();break;case"h4":simplemde.toggleHeading4();break;case"h5":simplemde.toggleHeading5();break;case"h6":simplemde.toggleHeading6();break;case"b":simplemde.toggleBold();break;case"i":simplemde.toggleItalic();break;case"del":simplemde.toggleStrikethrough();break;case"ul":simplemde.toggleUnorderedList();break;case"ol":simplemde.toggleOrderedList();break;case"a":simplemde.drawLink();break;case"img":simplemde.drawImage();break;case"code":simplemde.toggleCodeBlock();break;case"blockquote":simplemde.toggleBlockquote();break;case"table":simplemde.drawTable();break;case"hr":simplemde.drawHorizontalRule()}}),ipcRenderer.on("html",(e,t)=>{if(!simplemde.isPreviewActive())switch(t){case"small":case"sup":case"sub":case"u":case"mark":wrapTextToSelection(`<${t}>`,`</${t}>`);break;case"dl":insertTextAtCursor("<dl>\n\t<dt>title</dt>\n\t<dd>description</dd>\n\t<dt>title</dt>\n\t<dd>description</dd>\n</dl>")}}),ipcRenderer.on("set-zoom-level",(e,t)=>{let o=store.get("appSettings.zoom");switch(t){case 1:++o>16&&(o=16);break;case-1:--o<4&&(o=4);break;default:o=10}store.set("appSettings.zoom",o),applyZoom(o)}),ipcRenderer.on("context-favorite",(e,t)=>{let o="true"!=t.favorite;apiCall("update",t.id,{favorite:o})}),ipcRenderer.on("context-export",(e,t)=>{apiCall("export",t)}),ipcRenderer.on("context-delete",(e,t)=>{deleteCheck(t)}),$("body").on("click","#sidebar li button",function(e){e.stopPropagation();let t=$(this).data("id");$("#time").html(""),$("#note").html('<div class="loader"></div>'),$("#sidebar li button").removeClass("selected").removeClass("above-selected"),$(this).addClass("selected").parent().prev().children().addClass("above-selected"),apiCall("single",t),store.set("appInterface.selected",t)}),$("body").on("mouseup","#sidebar li button",function(e){e.stopPropagation();let t={id:$(this).data("id"),title:$(this).data("title"),favorite:$(this).attr("data-favorite")};3!==e.which||ipcRenderer.send("show-sidebar-menu",t)}),$("body").on("focus","#sidebar li button",function(e){$(this).parent().prev().children().addClass("above-selected")}),$("body").on("focusout","#sidebar li button",function(e){$(this).hasClass("selected")||$(this).parent().prev().children().removeClass("above-selected")}),$("body").on("mouseup","aside",function(e){3===e.which&&ipcRenderer.send("show-sidebar-menu",null)}),$("body").on("click",".editor-preview a",e=>{e.preventDefault();let t=e.target.href;"file"!==t.substr(0,4)&&shell.openExternal(t)}),$(document).ready(function(){toggleSpellcheck(store.get("appSettings.spellcheck")),server&&username&&password?apiCall("all"):openModal("file://"+__dirname+"/../html/login.html",480,180,!1),$("#edit").click(function(){editNote()})});
//# sourceMappingURL=maps/app.min.js.map
