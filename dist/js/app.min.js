"use strict";const{ipcRenderer:ipcRenderer,shell:shell}=require("electron"),Store=require("electron-store"),store=new Store,{remote:remote}=require("electron"),dialog=remote.dialog,dateFormat=require("dateformat"),$=require("jquery"),marked=require("marked"),removeMarkdown=require("remove-markdown"),pretty=require("pretty"),fs=require("fs-extra"),server=store.get("loginCredentials.server"),username=store.get("loginCredentials.username"),password=store.get("loginCredentials.password");let modal;const EasyMDE=require("easymde");let easymdeSetup={element:$("#note")[0],autofocus:!1,forceSync:!0,status:!1,spellChecker:!0,toolbar:[{name:"Heading",action:EasyMDE.toggleHeadingSmaller,className:"fa fa-header",title:"Heading"},"|",{name:"bold",action:EasyMDE.toggleBold,className:"fa fa-bold",title:"Bold"},{name:"italic",action:EasyMDE.toggleItalic,className:"fa fa-italic",title:"Italic"},{name:"srtikethrough",action:EasyMDE.toggleStrikethrough,className:"fa fa-strikethrough",title:"Strikethrough"},"|",{name:"unordered-list",action:EasyMDE.toggleUnorderedList,className:"fa fa-list-ul",title:"Generic List"},{name:"ordered-list",action:EasyMDE.toggleOrderedList,className:"fa fa-list-ol",title:"Numbered List"},"|",{name:"link",action:EasyMDE.drawLink,className:"fa fa-link",title:"Create Link"},{name:"image",action:EasyMDE.drawImage,className:"fa fa-picture-o",title:"Insert Image"},"|",{name:"code",action:EasyMDE.toggleCodeBlock,className:"fa fa-code",title:"Code"},{name:"quote",action:EasyMDE.toggleBlockquote,className:"fa fa-quote-left",title:"Quote"},{name:"table",action:EasyMDE.drawTable,className:"fa fa-table",title:"Insert Table"},{name:"horizontal-rule",action:EasyMDE.drawHorizontalRule,className:"fa fa-minus",title:"Insert Horizontal Line"}],shortcuts:{toggleStrikethrough:"Cmd-Alt-D",toggleBlockquote:"Cmd-'",drawTable:"Cmd-T",drawHorizontalRule:"Cmd--",cleanBlock:null,toggleSideBySide:null,toggleFullScreen:null,togglePreview:null}},easymde=new EasyMDE(easymdeSetup);function apiCall(e,t,a){let o;switch(e){case"new":o="post";break;case"save":case"update":o="put";break;case"delete":o="delete";break;default:o="get"}let r="/index.php/apps/notes/api/v0.2/notes",s={method:o,headers:{Authorization:"Basic "+btoa(username+":"+password),"Content-Type":"application/json"},mode:"cors",cache:"no-store"};t&&(r+=`/${t}`),a&&(s.body=JSON.stringify(a)),console.log(`URL: ${r}`),fetch(server+r,s).then(function(e){if(e.ok)return console.log("response OK"),e.text();dialog.showErrorBox("Server connection error",`there was an error connecting to :\n${server}`),console.log(e.error())}).then(function(o){let r=JSON.parse(o);if("error"==r.status)dialog.showErrorBox("JSON parsing error","An error occured parsing the notes"),console.log(r.message);else switch(e){case"new":store.set("appInterface.selected",r.id),$("#sidebar").html(""),apiCall("all");break;case"save":$("#sidebar").html(""),apiCall("sidebar");break;case"update":$(`button[data-id="${t}"]`).removeData("favorite"),$(`button[data-id="${t}"]`).attr("data-favorite",a.favorite);break;case"delete":$("#sidebar li button.selected").attr("data-id")==t&&(resetEditor(),store.set("appInterface.selected",null),$("#note").attr("data-id",null),$("#time, #note").html("")),$("#sidebar").html(""),apiCall("all");break;case"export":exportNote(r);break;case"sidebar":listNotes(r,"sidebar");break;default:t?displayNote(r):listNotes(r)}}).catch(function(e){dialog.showErrorBox("Server connection error",`there was an error connecting to :\n${server}`),console.log(e)})}function resetEditor(){easymde.codemirror.setValue(""),easymde.value(""),$(".editor-preview").html("")}function insertTextAtCursor(e){let t=easymde.codemirror.getDoc(),a=t.getCursor();t.replaceRange(e,a)}function wrapTextToSelection(e,t){let a=easymde.codemirror.getDoc(),o=a.getSelection();a.replaceSelection(e+o+t)}function listNotes(e,t){const a=(new Date).getTime()/1e3;let o=store.get("appSettings.sortby"),r=store.get("appSettings.orderby");e.length>1&&e.sort(function(e,t){var a=e[o],s=t[o];return"asc"===r?a<s?-1:a>s?1:0:a>s?-1:a<s?1:0});for(let t of e){let e=formatDate(a,new Date(t.modified).getTime()),o=removeMarkdown(t.content.replace(/(!\[.*\]\(.*\)|<[^>]*>|>|<)/g,""));o=o?o.substr(0,120).slice(t.title.length):"No additional text",$("#sidebar").append(`<li>\n\t\t\t<button data-id="${t.id}" data-title="${t.title}" data-category="${t.category}" data-favorite="${t.favorite}">\n\t\t\t\t<span class="side-title">${t.title}</span>\n\t\t\t\t<span class="side-text">${e}&nbsp;&nbsp;${o}</span>\n\t\t\t</button>\n\t\t</li>\n\t\t`)}t?getSelected("sidebar"):getSelected()}function formatDate(e,t){return dateFormat(1e3*t,e-86400<t?"H:MM":e-604800<t?"dddd":"dd/mm/yy")}function displayNote(e){let t=dateFormat(1e3*e.modified,"d mmmm, yyyy"),a=dateFormat(1e3*e.modified,"HH:MM");$(".CodeMirror-code").addClass("hide"),$("#edit").removeClass("editing"),$("#time").html(`${t} at ${a}`),resetEditor(),easymde.isPreviewActive()&&easymde.togglePreview(),$("#note").attr("data-id",e.id),easymde.value(e.content),easymde.codemirror.clearHistory(),easymde.togglePreview(),applyZoom(store.get("appSettings.zoom")),$(".CodeMirror-code").removeClass("hide")}function getSelected(e){let t=store.get("appInterface.selected");t&&($(`button[data-id="${t}"]`).addClass("selected").parent().prev().children().addClass("above-selected"),e||apiCall("single",t))}function editNote(){let e=store.get("appInterface.selected");if(e)if(easymde.isPreviewActive())$("#edit").addClass("editing"),easymde.togglePreview(),easymde.codemirror.focus(),"end"==store.get("appSettings.cursor")&&easymde.codemirror.setCursor(easymde.codemirror.lineCount(),0);else{if(easymde.codemirror.historySize().undo>0){if(0===dialog.showMessageBox(remote.getCurrentWindow(),{message:"You have made changes to this note",detail:"Do you want to save them?",buttons:["Save changes","Cancel"]})){let t=easymde.value();easymde.codemirror.clearHistory(),apiCall("save",e,{content:t,modified:Math.floor(Date.now()/1e3)})}else for(;easymde.codemirror.historySize().undo>0;)easymde.codemirror.undo()}easymde.togglePreview(),$("#edit").removeClass("editing").focus()}}function saveNote(e){if(!easymde.isPreviewActive()&&easymde.codemirror.historySize().undo>0){console.log("SAVING!!"),apiCall("save",e,{content:easymde.value(),modified:Math.floor(Date.now()/1e3)})}}function exportNote(e){const t=store.get("exportPath");dialog.showSaveDialog(remote.getCurrentWindow(),{defaultPath:`${t}/${e.title}`,buttonLabel:"Export Note",properties:["openDirectory","createDirectory"],filters:[{name:"html",extensions:["html"]},{name:"markdown",extensions:["md"]},{name:"text",extensions:["txt"]}]},function(t){let a,o;switch(t.split(".").pop()){case"html":let r=marked(e.content);a=pretty(`<!doctype html><html lang="en"><head><meta charset="utf-8" /><title>${e.title}</title></head><body>${r}</body></html>`,{ocd:!0}),o="html";break;case"txt":a=removeMarkdown(e.content),o="text";break;default:a=e.content,o="markdown"}fs.outputFile(t,a).then(()=>fs.readFile(t,"utf8")).then(t=>{new Notification("Nextcloud Notes Client",{body:`The note ${e.title} has been exported as ${o}.`})}).catch(e=>{console.error(e)})})}function deleteCheck(e){0===dialog.showMessageBox(remote.getCurrentWindow(),{message:"Are you sure you want to delete this note?",detail:"This operation is not reversable.",buttons:["Delete Note","Cancel"]})&&apiCall("delete",e)}function applyZoom(e){$(".editor-preview").css({"font-size":`${e/10}rem`})}function toggleSpellcheck(e){e?$(".CodeMirror").addClass("spellcheck"):$(".CodeMirror").removeClass("spellcheck")}function toggleCursorPosition(e){alert(e)}function openModal(e,t,a,o){(modal=new remote.BrowserWindow({parent:remote.getCurrentWindow(),modal:!0,width:t,minWidth:t,maxWidth:t,height:a,minHeight:a,resizable:o,show:!1,backgroundColor:"#ececec",webPreferences:{nodeIntegration:!0}})).loadURL(e),modal.once("ready-to-show",()=>{modal.show()})}ipcRenderer.on("set-zoom-slider",(e,t)=>{applyZoom(t)}),ipcRenderer.on("reload-sidebar",()=>{$("#sidebar").html(""),apiCall("all")}),ipcRenderer.on("spellcheck",(e,t)=>{toggleSpellcheck(t)}),ipcRenderer.on("open-login-modal",(e,t)=>{openModal("file://"+__dirname+"/../html/login.html",480,180,!1)}),ipcRenderer.on("close-login-modal",(e,t)=>{modal.close()}),ipcRenderer.on("note",(e,t)=>{let a=store.get("appInterface.selected");switch(t){case"new":apiCall("new",null,{content:"# New note"});break;case"edit":a&&editNote(a);break;case"save":a&&saveNote(a);break;case"favorite":if(a){apiCall("update",a,{favorite:"true"!=$(`#sidebar li button[data-id="${a}"]`).attr("data-favorite")})}break;case"export":a&&apiCall("export",a);break;case"delete":a&&deleteCheck(a)}}),ipcRenderer.on("markdown",(e,t)=>{if(!easymde.isPreviewActive())switch(t){case"h1":easymde.toggleHeading1();break;case"h2":easymde.toggleHeading2();break;case"h3":easymde.toggleHeading3();break;case"h4":easymde.toggleHeading4();break;case"h5":easymde.toggleHeading5();break;case"h6":easymde.toggleHeading6();break;case"b":easymde.toggleBold();break;case"i":easymde.toggleItalic();break;case"del":easymde.toggleStrikethrough();break;case"ul":easymde.toggleUnorderedList();break;case"ol":easymde.toggleOrderedList();break;case"a":easymde.drawLink();break;case"img":easymde.drawImage();break;case"code":easymde.toggleCodeBlock();break;case"blockquote":easymde.toggleBlockquote();break;case"table":easymde.drawTable();break;case"hr":easymde.drawHorizontalRule()}}),ipcRenderer.on("html",(e,t)=>{if(!easymde.isPreviewActive())switch(t){case"small":case"sup":case"sub":case"u":case"mark":wrapTextToSelection(`<${t}>`,`</${t}>`);break;case"dl":insertTextAtCursor("<dl>\n\t<dt>title</dt>\n\t<dd>description</dd>\n\t<dt>title</dt>\n\t<dd>description</dd>\n</dl>")}}),ipcRenderer.on("set-zoom-level",(e,t)=>{let a=store.get("appSettings.zoom");switch(t){case 1:++a>16&&(a=16);break;case-1:--a<4&&(a=4);break;default:a=10}store.set("appSettings.zoom",a),applyZoom(a)}),ipcRenderer.on("context-favorite",(e,t)=>{let a="true"!=t.favorite;apiCall("update",t.id,{favorite:a})}),ipcRenderer.on("context-export",(e,t)=>{apiCall("export",t)}),ipcRenderer.on("context-delete",(e,t)=>{deleteCheck(t)}),$("body").on("click","#sidebar li button",function(e){e.stopPropagation();let t=$(this).data("id");$("#time").html(""),$("#note").html('<div class="loader"></div>'),$("#sidebar li button").removeClass("selected").removeClass("above-selected"),$(this).addClass("selected").parent().prev().children().addClass("above-selected"),apiCall("single",t),store.set("appInterface.selected",t)}),$("body").on("mouseup","#sidebar li button",function(e){e.stopPropagation();let t={id:$(this).data("id"),title:$(this).data("title"),favorite:$(this).attr("data-favorite")};3!==e.which||ipcRenderer.send("show-sidebar-menu",t)}),$("body").on("focus","#sidebar li button",function(e){$(this).parent().prev().children().addClass("above-selected")}),$("body").on("focusout","#sidebar li button",function(e){$(this).hasClass("selected")||$(this).parent().prev().children().removeClass("above-selected")}),$("body").on("mouseup","aside",function(e){3===e.which&&ipcRenderer.send("show-sidebar-menu",null)}),$("body").on("click",".editor-preview a",e=>{e.preventDefault();let t=e.target.href;"file"!==t.substr(0,4)&&shell.openExternal(t)}),$(document).ready(function(){toggleSpellcheck(store.get("appSettings.spellcheck")),server&&username&&password?apiCall("all"):openModal("file://"+__dirname+"/../html/login.html",480,180,!1),$("#edit").click(function(){editNote()})});
//# sourceMappingURL=maps/app.min.js.map
